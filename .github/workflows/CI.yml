name: ðŸš€ Tests, builds, packs

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# cancels the previous workflow run when a new one appears in the same branch (e.g. master or a PR's branch)
concurrency:
  group: CI_${{ github.ref }}
  cancel-in-progress: true

jobs:


#  test:
#    name: test
#    runs-on: ubuntu-22.04
#    steps:
#      - run: echo 123 > test
#      - name: Upload build artifacts
#        uses: manticoresoftware/upload_artifact_with_retries@main
#        with:
#          name: test
#          path: test

  build_linux_release:
    name: Linux release build
    uses: ./.github/workflows/build_template.yml

  build_linux_debug:
    name: Linux debug build
    uses: ./.github/workflows/build_template.yml
    with:
      CTEST_CONFIGURATION_TYPE: "Debug"

  build_windows:
    name: Windows x64 build
    uses: ./.github/workflows/build_template.yml
    with:
      DISTR: windows #
      arch: x64 #
      CTEST_CMAKE_GENERATOR: "Ninja Multi-Config" #
      CTEST_CONFIGURATION_TYPE: Debug #
      cache_key: build_windows_x64 #
      artifact_list: "build/xml build/columnar/Debug/lib_manticore_columnar.dll build/secondary/Debug/lib_manticore_secondary.dll build/_deps/manticore-build/src/Debug/indexer.exe build/_deps/manticore-build/src/Debug/searchd.exe" #

  test_linux_debug:
    name: Linux debug mode tests
    needs: build_linux_debug
    uses: ./.github/workflows/test_template.yml
    strategy:
      fail-fast: false
      matrix:
        name: [1_50,51_100,101_150,151_200,201_250,251_300,301_350,350_400,401_and_on]
        include:
          - name: 1_50
            start: 1
            end: 50
          - name: 51_100
            start: 51
            end: 100
          - name: 101_150
            start: 101
            end: 150
          - name: 151_200
            start: 151
            end: 200
          - name: 201_250
            start: 201
            end: 250
          - name: 251_300
            start: 251
            end: 300
          - name: 301_350
            start: 301
            end: 350
          - name: 351_400
            start: 351
            end: 400
          - name: 401_and_on
            start: 401
            end: 999999
    with:
      CTEST_CONFIGURATION_TYPE: "Debug"
      CTEST_START: ${{ matrix.start }}
      CTEST_END: ${{ matrix.end }}
      artifact_name: debug_test_${{ matrix.name }}
      xml_command: "cd build; cp -r Testing/2*/Test.xml .; xsltproc -o junit_tests_${{ matrix.name }}.xml ../misc/junit/ctest2junit.xsl Test.xml"
      timeout: 10

  test_linux_release:
    name: Linux release mode tests
    needs: build_linux_release
    uses: ./.github/workflows/test_template.yml
    strategy:
      fail-fast: false
      matrix:
        name: [1_50,51_100,101_150,151_200,201_250,251_300,301_350,350_400,401_and_on]
        include:
          - name: 1_50
            start: 1
            end: 50
          - name: 51_100
            start: 51
            end: 100
          - name: 101_150
            start: 101
            end: 150
          - name: 151_200
            start: 151
            end: 200
          - name: 201_250
            start: 201
            end: 250
          - name: 251_300
            start: 251
            end: 300
          - name: 301_350
            start: 301
            end: 350
          - name: 351_400
            start: 351
            end: 400
          - name: 401_and_on
            start: 401
            end: 999999
    with:
      CTEST_CONFIGURATION_TYPE: "RelWithDebInfo"
      CTEST_START: ${{ matrix.start }}
      CTEST_END: ${{ matrix.end }}
      artifact_name: release_test_${{ matrix.name }}
      xml_command: "cd build; cp -r Testing/2*/Test.xml .; xsltproc -o junit_tests_${{ matrix.name }}.xml ../misc/junit/ctest2junit.xsl Test.xml"
      timeout: 10
